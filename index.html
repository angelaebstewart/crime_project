<!DOCTYPE html>
<meta charset="utf-8">
<style>

.counties {
  fill: none;
  stroke: #aaa;
}

.states {
  fill: none;
  stroke: #000;
  stroke-linejoin: round;
}

</style>
<div id="tutorial" style="float: left;">
<button id="tutorial_button" onclick="show_tutorial()">Tutorial</button>
<div id="tutorial_content" style="display: none; border: solid; border-width: thin;">
Click any county on the map to highlight it.
<br/>
Doubleclick on a county to zoom in on it.
<br/>
Doubleclicking will cause the bar charts and scatterplot to display data on the state the selected county is in.
</br>
Click and drag on the map to pan.
<br/>
Holding the mouse over a county will show a tooltip with information about the county.
<br/><br/>
Task 1: Find the rate of property crime of your home county.
<br/>
Task 2: Find how much more/less violent crime per capita is committed in Texas than Hawaii.
<br/>
Task 3: Find 3 states that have high rates of burglary.
</div>
</div>

<div id="project_description" style="text-align: center; margin: auto; width: 500px;">
<p>
<h3>Project Overview</h3>
Currently, sociologists often rely on tables to understand trends in their area of research. This can become incredibly tedious and complex, especially in an area like criminology which is at the intersection of studies on race, class, and the criminal justice system. In order to help present a more centralized place for this kind of information, we have created a visualization of the FBI Uniform Crime Report of 2014 along with accompanying demographic data from census estimates for 2014.
<br/><br/>
Our target users are undergraduate students studying criminology for the first time. Their professors are also important users because the visualization must fit within the course's content. We feel this tool is best suited for beginners because diving into data with only tables can be especially confusing for those just getting started (i.e. undergraduates). We also believe the questions our users want answered are also suited for the general population, though more focus is placed on satisfying learning outcomes for a criminology course.
<br/><br/>
In our conversations with an undergraduate sociology professor at Hanover College, we have found a couple broad questions users want answered:
What does crime look like in the US? 
Are there demographic commonalities related to reported crime?
<br/><br/>
This visualization attempts to facilitate student exploration as they answer those questions.
</p>
<br/>
<p>
<h3>Visualization Walkthrough</h3>
The first element of our visualization the user will see is the interactive choropleth. The user can mouseover for more info on a county, zoom in for detailed information on a single state, and pan around the map (which is especially useful for zoomed views). We chose to present a choropleth because it provides a familiar representation of the data for our users, organizes the data spatially, and by its nature implies some level of interactivity to get our users engaged.
<br/><br/>
A panel with radio buttons allows the student to select different data to view on the map and following section of the visualization. At first the user is presented a choropleth of the population of the US, but by selecting a different option in the panel they can see the crime rates of each county as a choropleth.
</p>
</div>
<div id="map">
<!--<h4>Search for a specific county:</h4>
<div id="map_search" width="960" style="border: solid; border-width: thin; width: 500px;"></div><br/>-->

<div id="map_search" width="960" style="width: 500px;"></div><br/>

<svg id="svg" width="960" height="600"></svg>
</div>
<br/><br/>
<div id="chart_description" style="text-align: center; margin: auto; width: 500px;">
<p>
The second element of our visualization is a collection of bar charts and a scatterplot showing aggregated information. If a student is zoomed out to the scope of the entire nation, the bar charts show demographic information on sex, race, and median income for the country. The scatterplot displays the relationship between the population and total rate of crime for each state. As stated before, selecting a different type of data in the radio button panel will alter the view presented both in the map and in the scatterplot. The scatterplot will change to a relationship between the population and crime rate of whichever crime type is selected. If the "Population" radio button is selected, the scatterplot returns to its default view.
<br/><br/>
When the user zooms in a particular state, the bar charts will update to show the demographics for the state selected. For example, if a user zooms in on Indiana with the "Property Crime" radio button selected, the bar charts will show sex and race demographics for the state as well as the median income for all counties in Indiana. The scatterplot will show the relationship between the population and property crime rates of each county in Indiana.
<br/><br/>
We chose to use these three bar charts and scatterplot as a means for students to get information at a glance instead of only providing the single interface through the choropleth. Since bar charts and scatterplots are very common visualizations, we also thought the familiarity of these kinds of charts would make the visualization as a whole more accessible.
</div>
<div id="updatableChart"></div>
<br/><br/>
<div id="scatter"></div>
<!--<svg id="svg2" width="960" height="600"></svg>-->
<div id="interesting_finds" style="text-align: center; margin: auto; width: 500px;">
<p>
<h3>Interesting Insights</h3>
1. The United States is very sparsely populated. The largest cities on on the coast, and there are very few densely populated areas.
<br/><br/>
2. 
<br/><br/>
3. 
</p>
<br/>
<p>
<h3>Developer Insights</h3>
1. The right data is not always easily available. To gather the correct data, we literally had to email someone at the FBI.
<br/><br/>
2. Having an updatable D3 skeleton is important early on.
</p>
<br/>
<p>
<h3>If We Had More Time</h3>
1. Revisit search bar feature for finding a specific county.
<br/><br/>
2. Find a single, more complete data set.
<br/><br/>
3. Meet with the users more often, however this would require travel.
</p>
<br/>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="http://lorenzoongithub.github.io/completely/complete.ly.1.0.1.min.js"></script>
<script src="barChart.js"></script>
<script src="getters.js"></script>
<style>
	div {
		padding: 20px 0 0 10px;
	}
</style>
<script>
var tutorial_clicks = 0;
function show_tutorial() {
	tutorial_clicks++;
	var tut = document.getElementById("tutorial_content");
	if(tutorial_clicks % 2 != 0) {
		tut.setAttribute("style", "border: solid; border-width: thin; width: 500px;");
	}
	else {
		tut.setAttribute("style", "display: none;");
	}
	return 0;
}	

//CHOROPLETH DATA
var svg = d3.select("#svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var clicked = 0;

var selected = "";

var max = 0;

var min = 999999999;

var heatmap = d3.map();

var path = d3.geoPath();

var zoom = d3.zoom()
	.duration(750)
    .scaleExtent([1, 3])
    .on("zoom", zoomed);

var json = [];
var acc = 0;

/*var map_div = document.getElementById("map_search");
var searchbox = completely(map_div);
searchbox.options = [];
//var search_div = document.getElementById("map_search").firstChild.firstChild.innerHTML;
var text_div = document.querySelectorAll('[style="position: absolute; visibility: hidden; outline: 0px none; margin: 0px; padding: 0px; text-align: left; font-size: 16px; font-family: sans-serif; background-color: rgb(255, 255, 255); z-index: 100; cursor: default; border-style: solid; border-width: 1px; border-color: rgb(170, 170, 170); overflow-x: hidden; white-space: pre; overflow-y: scroll;"]')[0];
text_div.setAttribute("id", "county_selector");
var search_div = document.querySelectorAll('[spellcheck="false"]')[1];
search_div.setAttribute("onKeydown", "Javascript: if (event.keyCode==13) alert(document.getElementById(\"county_selector\").innerHTML);");
*/
d3.queue()
    .defer(d3.json, "https://d3js.org/us-10m.v1.json")
    .defer(d3.csv, "data2.csv", function(d) {
                  if(d.geoid < 10000) { d.geoid = "0" + d.geoid; }
                  if(d.violent != null && d.violent != "-1" && d.property != null && d.property != "-1") { d.overall = Number(d.violent) + Number(d.property); } else { d.overall = -1; }
		  json.push({"geoid": d.geoid, "county": d.county, "state": d.state, "population": d.population, "male": d.male, "female": d.female, "other": d.other, "asian": d.asian, "black": d.black, "hawaiian": d.hawaiian, "aboriginal": d.aboriginal, "multiple": d.multiple, "white": d.white, "violent": d.violent, "property": d.property, "murder": d.murder, "rape": d.rape, "robbery": d.robbery, "assault": d.assault, "burglary": d.burglary, "larceny": d.larceny, "motor": d.vehicle, "overall": d.overall, "active": d.population});
		  //searchbox.options.push(d.county + ", " + d.state);
                  if(parseInt(d.population) > max) { max = parseInt(d.population); } if(parseInt(d.population) < min && parseInt(d.population) != -1) { min = parseInt(d.population); } heatmap.set(d.geoid, +acc);
                  acc++;
		})
    .await(ready);

var x = d3.scaleLinear()
    .domain([1, 10])
    .rangeRound([600, 860]);

var color = d3.scaleThreshold()
    .domain(d3.range(1, 10))
    .range(d3.schemeGreens[9]);

var g = svg.append("g")
    .attr("class", "key")
    .attr("transform", "translate(0,40)"); 

g.selectAll("rect")
  .data(color.range().map(function(d) {
      d = color.invertExtent(d);
      if (d[0] == null) d[0] = x.domain()[0];
      if (d[1] == null) d[1] = x.domain()[1];
      return d;
    }))
  .enter().append("rect")
    .attr("height", 8)
    .attr("x", function(d) { return x(d[0]); })
    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    .attr("fill", function(d) { return color(d[0]); });

g.append("text")
    .attr("class", "caption")
    .attr("id", "caption")
    .attr("x", x.range()[0])
    .attr("y", -6)
    .attr("fill", "#000")
    .attr("text-anchor", "start")
    .attr("font-weight", "bold")
    .text("Population of US Counties");

g.call(d3.axisBottom(x)
    .tickSize(13)
    .tickFormat(function(x, i) { return i ? x: x; })
    //.tickValues(color.domain()))
    .tickValues([1, 2, 3, 4, 5, 6, 7, 8, 9]))
  .select(".domain")
    .remove();

var active_data = "Population";

function get_active(d, opt) {
    var active;
    active_data = opt;
    switch(opt) {
        case "Murder & Nonnegligent Manslaughter":
            active = d.murder;
            break;
        case "Rape":
            active = d.rape;
            break;
        case "Robbery":
            active = d.robbery;
            break;
        case "Aggravated Assault":
            active = d.assault;
            break;
        case "Burglary":
            active = d.burglary;
            break;
        case "Larceny-Theft":
            active = d.larceny;
            break;
        case "Motor Vehicle Theft":
            active = d.vehicle;
            break;
        case "Violent Crime":
            active = d.violent;
            break;
        case "Property Crime":
            active = d.property;
            break;
        case "Overall Crime":
            active = d.overall;
            break;
        default:
            active = d.population;
            break;

    }
    return active;
}

function update_caption(opt) {
    var cap = document.getElementById("caption");
    cap.innerHTML = active_data + " of US Counties";
    return 0;
}

function update_map(opt) {
   max = 0;
   min = 999999999;
   heatmap.clear();
   acc = 0;
   json = [];
   d3.queue()
    .defer(d3.json, "https://d3js.org/us-10m.v1.json")
    .defer(d3.csv, "data2.csv", function(d) {
                  if(d.geoid < 10000) { d.geoid = "0" + d.geoid; }
                  if(d.violent != null && d.violent != "-1" && d.property != null && d.property != "-1") { d.overall = Number(d.violent) + Number(d.property); } else { d.overall = -1; }
                  d.active = get_active(d, opt);
                  update_caption(opt);
		  json.push({"geoid": d.geoid, "county": d.county, "state": d.state, "population": d.population, "male": d.male, "female": d.female, "other": d.other, "asian": d.asian, "black": d.black, "hawaiian": d.hawaiian, "aboriginal": d.aboriginal, "multiple": d.multiple, "white": d.white, "violent": d.violent, "property": d.property, "overall": d.overall, "murder": d.murder, "rape": d.rape, "robbery": d.robbery, "assault": d.assault, "burglary": d.burglary, "larceny": d.larceny, "motor": d.vehicle, "active": d.active});
		  if(Number(d.active) > max) { max = Number(d.active); } if(Number(d.active) < min && Number(d.active) != -1) { min = Number(d.active); } heatmap.set(d.geoid, +acc);
                  acc++;
		})
    .await(ready);
    //update_ticks();
    return 0;
}

function update_ticks() {
    var ticks = document.getElementsByClassName("tick");
    for(var t = 0; t < ticks.length; t++) {
        if(t == 0) { ticks[t].innerHTML = "<line stroke=\"#000\" y2=\"13\" x1=\"0.5\" x2=\"0.5\"></line><text fill=\"#000\" y=\"16\" x=\"0.5\" dx=\"1.5em\" dy=\"1em\" transform=\"rotate(30)\">" + min + "</text>"; }
        else { ticks[t].innerHTML = "<line stroke=\"#000\" y2=\"13\" x1=\"0.5\" x2=\"0.5\"></line><text fill=\"#000\" y=\"16\" x=\"0.5\" dx=\"1.5em\" dy=\"1em\" transform=\"rotate(30)\">" + Math.ceil(max * ((t + 1.0) / 9.0)) + "</text>"; }
    }
    return 0;
}


function ready(error, us) {
  if (error) throw error;

  update_ticks();
  svg.append("g")
      .attr("id", "map_counties")
      .call(zoom).on("wheel.zoom", null)
      .attr("class", "counties")
	  .attr("border", 1)
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
	  .attr("id", function(d) { var v = heatmap.get(d.id);
		  if(json[v] != null) { return json[v].county + ", " + json[v].state; }
		  else { return d.id; } })
      .attr("fill", function(d) { var v = heatmap.get(d.id); 
          if(json[v] != null) { d.value = Number(json[v].active); d.properties = json[v]; } 
          if(d.value != null && d.value != -1) { return color(((d.value * 1.0) / (max * 1.0)) * 90); } else { return "grey"; }})
	  //.on("mouseover", function(d) { selected = d.id; })
	  .on("click", function(d) { var obj = d3.select(this);
	    if(obj.attr("fill") == "yellow") {
                obj.attr("id", "");
	        obj.attr("fill", function (d) { 
		if(d.value != null && d.value != -1) {
		  return color(((d.value * 1.0) / (max * 1.0)) * 90); 
		} 
		else { return "grey"; } 
		}); }
	    else { 
                var curr = document.getElementById("selected"); 
                if(curr != null) { curr.setAttribute("fill", selected); curr.setAttribute("id", ""); }
                obj.attr("id", "selected"); selected = d3.select(this).attr("fill"); d3.select(this).attr("fill", "yellow"); 
                county_highlight(d.id);
            }})
	  .on("dblclick", function(d) { clicked++;
              if(clicked % 3 != 0) {
                  var data = json[heatmap.get(d.id)];
                  context_change(raceChart, sexChart, incomeChart, data.state);
              }
              //var state;
		/*for(var j = 0; j < json.length; j++) { 
		  if(json[j].geoid == d.id) {
			state = json[j].state;
			}
		}
		for(var j = 0; j < json.length; j++) { 
		  if(json[j].state == state) {
			d3.select("#" + json[j].geoid).attr("border", 2);
			}
		}*/
	  })
      .attr("d", path)
    .append("title")
      .text(function(d) { var info = ""; var data = json[heatmap.get(d.id)];
		if(d.value != null && d.value != -1) {info = data.county + ", " + data.state + "\n\nPopulation: " + data.population;
                    if(data.active != data.population) { info = info + "\n" + active_data + ": " + (Number(data.active)).toFixed(2) + " per capita"; }
                    info = info + "\n\nMale: " + (Number(data.male) * 100).toFixed(2) + "%\nFemale: " + (Number(data.female) * 100).toFixed(2) + "%\n\nAsian: " + (Number(data.asian) * 100).toFixed(2) + "%\nBlack: " + (Number(data.black) * 100).toFixed(2) + "%\nHawaiian or Pacific Islander: " + (Number(data.hawaiian) * 100).toFixed(2) + "%\nNative American: " + (Number(data.aboriginal) * 100).toFixed(2) + "%\nWhite: " + (Number(data.white) * 100).toFixed(2) + "%\nMultiracial: " + (Number(data.multiple) * 100).toFixed(2) + "%\nOther: " + (Number(data.other) * 100).toFixed(2) + "%"; 
                    return info;
                }
	  	else {
                    if(data != null && data.county != null && data.state != null) {
                        info = data.county + ", " + data.state + "\n";
                    }
                    if(data != null && data.active != null) {
                        info = info + "No crime data available."; return info;
                    }
                    info = info + "No data available."; return info;
                }
            });

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("id", "map_states")
      .attr("d", path);
}

function context_change(race, sex, income, state_selected) {
  race.data(getRaceData(nationalData, state_selected));
  sex.data(getSexData(nationalData, state_selected));
  income.data(getCountiesMedianIncome(countyData, state_selected));


    return 0;
}

function county_highlight(geoid) {

    return 0;
}

function zoomed() {
  if(clicked % 3 == 0) {
  	svg.attr("transform", "");

  }
  else {
  	svg.attr("transform", d3.event.transform);
  }
}
        //BAR AND SCATTER
        var countyData = [];
        var nationalData = [];
        var sexChart;
        var raceChart;
        var incomeChart;
        var crimeChart;

        createRadioButtons();
        
        d3.json("countyData.json", function(error, data) {
            if(error) {
                console.log(error);
            }
            
            countyData = data;

            d3.json("nationalData.json", function(error, data) {
              if(error) {
                console.log(error);
              }

              nationalData = data;
              
              sexChart = barChart().width(800).height(450).data(getSexData(nationalData, "United States"));
              d3.select('#updatableChart').call(sexChart);

              raceChart = barChart().width(800).height(450).data(getRaceData(nationalData, "United States"));
              d3.select('#updatableChart').call(raceChart);

              incomeChart = barChart().width(800).height(450).data(getStatesMedianIncome(nationalData));
              d3.select('#updatableChart').call(incomeChart);


              drawScatter(create_data(nationalData, "overall"));


            });

        });


        function createRadioButtons() {
            var crimeTypes = ["Population", "Overall Crime", "Violent Crime", "Property Crime", 
                "Burglary", "Larceny-Theft", "Motor Vehicle Theft", 
                "Murder & Nonnegligent Manslaughter", "Rape", 
                "Robbery", "Aggravated Assault"];
            var selected = 0;
            var form = d3.select("#map_search").append("form").attr("style", "float: left;");
            var labels = form.selectAll("span")
                .data(crimeTypes)
                .enter()
                .append("span");
            labels.append("input")
                .attr('type', 'radio')
                .attr('class', 'crime-toggles')
                .attr('name', 'crime')
                .attr('value', function(d, i) {return d;})
                .property("checked", function(d, i) {return i===selected;})
                .on('click', function () { radioOnClick(this.value);});
            labels.append("label").html(function(d) {return d + "<br/>";});
        }
        //Nate, add code for updating your chart here.
        function radioOnClick(toggle_val) {
            updatableChart.data(getCountiesMedianIncome(countyData, "AL")); //this is just in here as dummy data to show how to update the bar chart
	    update_map(toggle_val);
        }

//SCATTERPLOT
    function drawScatter(data) {
        var margin = {
            top: 20,
            right: 20,
            bottom: 30,
            left: 40
        },
        
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
        
        var x = d3.scaleLinear()
            .range([0, width]);

        var y = d3.scaleLinear()
            .range([height, 0]);

        var xAxis = d3.axisBottom()
            .scale(x)
            .ticks(0);

        var yAxis = d3.axisLeft()
            .scale(y)
            .ticks(0);


        var svg = d3.select("#scatter").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        svg.append("text")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 1000))
            .attr("text-anchor", "middle")  
            .style("font", "26px sans-serif")  
            .text("NAME THIS GRAPH HERE");

        data.forEach(function(d) {
            d.x = +d.x.value;
            d.y = +d.y.value;
            //console.log(d.x.label);
            d.label = d.x.label;
        });

        x.domain(d3.extent(data, function(d) {
            return d.x;
        }));

        y.domain(d3.extent(data, function(d) {
            return d.y;
        }));

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height/2 + ")")
            .call(xAxis)
            .append("text")
            .attr("class", "label")
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor", "end")
            .style("font", "24px sans-serif")
            .text("Crime Rate");

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .style("font", "24px sans-serif")
            .text("Population");

        svg.selectAll(".dot")
            .data(data)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("r", 3.5)
            .attr("cx", function(d) {
                return x(d.x);
            })
            .attr("cy", function(d) {
                return y(d.y);
            })
            .on("mouseover", function(d) { //console.log(d.label);
                d3.select(this).attr("fill", d3.rgb(0, 62, 31)); 
                var coordinates = d3.mouse(this); 
                focus.select("text").attr("x", coordinates[0]).attr("dy", coordinates[1] - 5).text("some text"); focus.style("display", null);
            })
            .on("mouseout", function() {d3.select(this).attr("fill",  d3.rgb(68, 143, 163)); focus.style("display", "none");});

        var focus = svg.append("g")
            .attr("class", "focus")
            .style("fill", "black")
            .style("display", "none");
                
        focus.append("text")
            .attr("x", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "middle");
    }


    function create_data(data, crime, id) {
        var x = []; //crime rate
        var y = []; //population
        if (typeof id === 'undefined') { 
            x = getStatesCrimeRate(data, crime);
            y = getStatesPopulation(data);
        } else {
            x = getCountiesCrimeRate(data, id, crime);
            y = getCountiesPopulation(data, id);

        }

        var dataOut = [];
        for (i = 0; i < y.length; i++) {
            dataOut.push({
                "y": y[i],
                "x": x[i]
            })
        }
        return dataOut;
    }

</script>
